<!DOCTYPE html>
<!-- include three.js -->
<script src='../vendor/three.js/build/three.js'></script>
<script src='../vendor/three.js/editor/js/libs/app.js'></script>

<!-- include js-aruco -->
<script src='../vendor/js-aruco/svd.js'></script>
<script src='../vendor/js-aruco/posit1-patched.js'></script>
<script src='../vendor/js-aruco/cv.js'></script>
<script src='../vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='../src/threex.webcamgrabbing.js'></script>
<script src='../src/threex.imagegrabbing.js'></script>
<script src='../src/threex.jsarucomarker.js'></script>


<body style='margin: 0px; overflow: hidden; text-align:center;'><script>
	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias	: true,
		alpha		: true,
	});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts = [];

	// init scene and camera
	var scene = new THREE.Scene()

	var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 10000);
	camera.position.z = 2;

	//////////////////////////////////////////////////////////////////////////////////
	//		init APP.Player()
	//////////////////////////////////////////////////////////////////////////////////
	var appPlayer = new APP.Player();
	appPlayer.setRenderer(renderer)
	appPlayer.setScene(scene)
	appPlayer.setCamera(camera)
	// appPlayer.dom = render
	appPlayer.setSize( window.innerWidth, window.innerHeight );

	//////////////////////////////////////////////////////////////////////////////////
	//		init a scene in player
	//////////////////////////////////////////////////////////////////////////////////

	// add a rotating earth to the scene
	;(function(){
return
		// add a torus
		var geometry = new THREE.SphereGeometry(0.5, 32, 16, Math.PI)
		var material = new THREE.MeshBasicMaterial( {
			map: THREE.ImageUtils.loadTexture("images/earth.jpg")
		})
		var mesh = new THREE.Mesh(geometry, material);
		scene.add( mesh );


		var scriptText = function(){
			function update(event){
				this.rotation.x += 0.1 * event.delta/1000 * Math.PI
			}
		}.toString().split('\n').slice(1, -1).join('\n')

		appPlayer.initScript(mesh, {
			source : scriptText
		})
	})()


	// add a awesome logo to the scene
	;(function(){
// return
		var material = new THREE.SpriteMaterial({
			map: THREE.ImageUtils.loadTexture( 'images/awesome.png' ),
		});
		var geometry = new THREE.BoxGeometry(1,1,1)
		var object3d = new THREE.Sprite(material );
		object3d.scale.set( 4, 4, 1 );
		scene.add(object3d)
	})()


	//////////////////////////////////////////////////////////////////////////////////
	//		attempts to load an app from the player
	//////////////////////////////////////////////////////////////////////////////////

	;(function(){
// return
		var loader = new THREE.XHRLoader();
		// var appUrl = '../vendor/three.js/editor/examples/arkanoid.app.json'
		// var appUrl = '../vendor/three.js/editor/examples/camera.app.json'
		// var appUrl = '../vendor/three.js/editor/examples/particles.app.json'
		// var appUrl = '../vendor/three.js/editor/examples/pong.app.json'
		var appUrl = 'apps/torusknot_rotating.app.json'
		loader.load(appUrl, function (text) {

			console.dir(appPlayer.dom)
			document.body.removeChild(appPlayer.dom)

			var json = JSON.parse(text);
			json.project = {
				vr: false
			}
			appPlayer.load(json)

			appPlayer.setSize(window.innerWidth, window.innerHeight)
			document.body.appendChild(appPlayer.dom)
			appPlayer.play();

			scene = appPlayer.getScene()

			appPlayer.setCamera(camera)


		});
	})()

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the scene
	//////////////////////////////////////////////////////////////////////////////////

	var mesh = new THREE.AxisHelper
	scene.add( mesh );

	//////////////////////////////////////////////////////////////////////////////////
	//		Launch the player
	//////////////////////////////////////////////////////////////////////////////////

	// launch the player
	appPlayer.play()

	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// handle window resize
	window.addEventListener('resize', function(){
		appPlayer.setSize( window.innerWidth, window.innerHeight );
	}, false)

	// set the scene as visible
	scene.visible	= false

	// run the rendering loop
	var lastTimeMsec= null
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// call each update function
		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(nowMsec, nowMsec - lastTimeMsec)
		})
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		Do the Augmented Reality Upgrade
	//////////////////////////////////////////////////////////////////////////////////


	// init the marker recognition
	var jsArucoMarker	= new THREEx.JsArucoMarker()


	// init the image source grabbing
	if( true ){
		var videoGrabbing = new THREEx.WebcamGrabbing()
		jsArucoMarker.videoScaleDown = 2
	}else if( true ){
		var videoGrabbing = new THREEx.ImageGrabbing()
		jsArucoMarker.videoScaleDown = 10
	}else console.assert(false)


        document.body.appendChild(videoGrabbing.domElement)


	// process the image source with the marker recognition
	onRenderFcts.push(function(){
		var domElement	= videoGrabbing.domElement
		var markers	= jsArucoMarker.detectMarkers(domElement)
		var object3d	= scene

		object3d.visible = false

		// see if this.markerId has been found
		markers.forEach(function(marker){
			if( marker.id !== 265 )	return

			jsArucoMarker.markerToObject3D(marker, object3d)

			object3d.scale.set(1,1,1)
				.multiplyScalar(1/10)

			object3d.visible = true
		})
	});
</script></body>
