<!DOCTYPE html>
<!-- include three.js -->
<script src='../vendor/three.js/build/three.js'></script>
<script src='../vendor/three.js/editor/js/libs/app.js'></script>

<!-- include js-aruco -->
<script src='../vendor/js-aruco/svd.js'></script>
<script src='../vendor/js-aruco/posit1-patched.js'></script>
<script src='../vendor/js-aruco/cv.js'></script>
<script src='../vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='../src/threex.webcamgrabbing.js'></script>
<script src='../src/threex.imagegrabbing.js'></script>
<script src='../src/threex.videograbbing.js'></script>
<script src='../src/threex.jsarucomarker.js'></script>

<script src='js/ui.image.js'></script>
<script src='js/ui.youtube.js'></script>
<script src='js/ui.vine.js'></script>

<body style='margin: 0px; overflow: hidden; text-align:center;'><script>
// TODO make an intro to this page
// - like an intro

	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias	: true,
		alpha		: true,
	});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts = [];

	// init scene and camera
	var scene = new THREE.Scene()
	var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 1000);
	camera.position.z = 2;

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the scene
	//////////////////////////////////////////////////////////////////////////////////

	// add a rotating earth to the scene
	;(function(){
return
		var geometry = new THREE.SphereGeometry(0.5, 32, 16, Math.PI)
		var material = new THREE.MeshBasicMaterial( {
			map: THREE.ImageUtils.loadTexture("images/earth.jpg")
		})
		var mesh = new THREE.Mesh(geometry, material);
		scene.add( mesh );
		onRenderFcts.push(function(now, delta){
			mesh.rotation.x += 0.1 * delta/1000 * Math.PI
		})
	})()

	// add some debug display
	;(function(){
return
		var geometry = new THREE.PlaneGeometry(1,1,10,10)
		var material = new THREE.MeshBasicMaterial( {
			wireframe : true
		})
		var mesh = new THREE.Mesh(geometry, material);
		scene.add( mesh );

		var mesh = new THREE.AxisHelper
		scene.add( mesh );
	})()

	// add a awesome logo to the scene
	;(function(){
// return
		var material = new THREE.SpriteMaterial({
			map: THREE.ImageUtils.loadTexture( 'images/awesome.png' ),
		});
		material.map.minFilter = THREE.LinearFilter
		var geometry = new THREE.BoxGeometry(1,1,1)
		var object3d = new THREE.Sprite(material );
		object3d.scale.set( 2, 2, 1 );
		scene.add(object3d)
	})()


	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// handle window resize
	window.addEventListener('resize', function(){
		renderer.setSize( window.innerWidth, window.innerHeight )
		camera.aspect	= window.innerWidth / window.innerHeight
		camera.updateProjectionMatrix()
	}, false)

	// set the scene as visible
	scene.visible	= false

	// render the scene
	onRenderFcts.push(function(){
		renderer.render( scene, camera );
	})

	// run the rendering loop
	var lastTimeMsec = performance.now()
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// call each update function
		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(nowMsec, nowMsec - lastTimeMsec)
		})
		// update
		lastTimeMsec	= nowMsec
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		Do the Augmented Reality Upgrade
	//////////////////////////////////////////////////////////////////////////////////


	// init the marker recognition
	var jsArucoMarker	= new THREEx.JsArucoMarker()

	// init the image source grabbing
	if( false ){
		var videoGrabbing = new THREEx.VideoGrabbing()
		jsArucoMarker.videoScaleDown = 10
	}else if( true ){
		var videoGrabbing = new THREEx.WebcamGrabbing()
		jsArucoMarker.videoScaleDown = 2
	}else if( true ){
		var videoGrabbing = new THREEx.ImageGrabbing()
		jsArucoMarker.videoScaleDown = 10
	}else console.assert(false)

	// attach the videoGrabbing.domElement to the body
        document.body.appendChild(videoGrabbing.domElement)


	// process the image source with the marker recognition
	var markers	= []
	onRenderFcts.push(function(){
		var domElement	= videoGrabbing.domElement
		markers	= jsArucoMarker.detectMarkers(domElement)
	})


	// jerome
	// init_youtube(42 , 'aU1vPpWhsLs')
	init_vine(42, 'eOt15nITeT2')

	// monica
	// init_youtube(175, '3OJuDPW_vk8')
	init_vine(175, 'eOtKtEVWrDA')

	// gaspard
	// init_youtube(60 , '-nNf6Xt23os')
	init_vine(60, 'eOTA3nQrI05')

	// andrea
	init_vine(236, 'eOtX0T2P1dJ')
	// init_youtube(236, '495qhR7_VPU')

	// gaia
	// init_youtube(32 , 'BmqmgsAYJiI')
	init_vine(32, 'eOV2a2UZ9zM')



	// process the image source with the marker recognition
	onRenderFcts.push(function(){
		var object3d = scene
		if(  markers.length === 0 ){
			object3d.visible = false
			return
		}

		var foundMarker	= markers[0]
	console.log('markerId', foundMarker.id)
		jsArucoMarker.markerToObject3D(foundMarker, object3d)
		object3d.visible = true
	})

// ---

	function init_vine(markerId, vineId){
		var uiPopup	= null
		var uiTimeout	= null

		// process the image source with the marker recognition
		onRenderFcts.push(function(){
			// see if this.markerId has been found
			var foundMarker	= null
			markers.forEach(function(marker){
				console.log('markerId', marker.id)
				if( marker.id !== markerId )	return
				foundMarker	= marker
			})

			// --
			if( foundMarker !== null ){
				if( uiPopup === null ){
					// uiPopup	= new UI.ImagePopup('images/office/gaspard.jpg')
					uiPopup	= new UI.VinePopup(vineId)
					document.body.appendChild(uiPopup.domElement)
				}
				clearTimeout( uiTimeout )
				uiTimeout = setTimeout(function(){
					document.body.removeChild(uiPopup.domElement)
					uiPopup	= null
				}, 1000)
			}
		})
	}

// ---------------------------

	function init_youtube(markerId, youtubeId){
		var uiPopup	= null
		var uiTimeout	= null

		// process the image source with the marker recognition
		onRenderFcts.push(function(){
			// see if this.markerId has been found
			var foundMarker	= null
			markers.forEach(function(marker){
				console.log('markerId', marker.id)
				if( marker.id !== markerId )	return
				foundMarker	= marker
			})

			// --
			if( foundMarker !== null ){
				if( uiPopup === null ){
					// uiPopup	= new UI.ImagePopup('images/office/gaspard.jpg')
					uiPopup	= new UI.YoutubePopup(youtubeId)
					document.body.appendChild(uiPopup.domElement)
				}
				clearTimeout( uiTimeout )
				uiTimeout = setTimeout(function(){
					document.body.removeChild(uiPopup.domElement)
					uiPopup	= null
				}, 1000)
			}
		})
	}
</script></body>
